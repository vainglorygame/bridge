<!doctype html>
<html>
    <head>
        <title>Vainsocial backend status</title>
    </head>
    <body>
        <form id="update-form">
            <input type="text">
            <input type="submit" value="Update">
        </form>

        <ul id="updates"></ul>

        <script src="https://cdn.jsdelivr.net/sockjs/1/sockjs.min.js"></script>
        <script type="text/javascript" src="/js/webstomp.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
        <script>
            let client;
            // set up the client
            if ('WebSocket' in window && (typeof WebSocket === 'function' || typeof WebSocket === 'object')) {
                client = webstomp.client("ws://localhost:15674/ws");
            } else {
                // http fallback
                client = webstomp.over(SockJS("http://localhost:15674/stomp"));
            }
            // connect
            client.connect("web", "web", () => {
                $("#updates").append(
                    $("<li>")
                    .text("connected to socket")
                    .css("color", "purple")
                );
            }, (err) => {
                $("#updates").append(
                    $("<li>")
                    .text("error connecting to socket: " + JSON.stringify(err))
                    .css("color", "red")
                );
            });

            $("#update-form").submit((e) => {
                let name = $("input:first").val();
                // subscribe
                client.subscribe("/topic/player." + name, (msg) => {
                    $("#updates").append(
                        $("<li>")
                        .text(msg.body)
                        .css("color", "grey")
                    );

                    if (msg.body == "search_fail")  {
                        $("#updates").append(
                            $("<li>")
                            .text(name + ": not found")
                            .css("color", "red")
                        );
                    }
                    if (msg.body == "search_success")  {
                        $("#updates").append(
                            $("<li>")
                            .text(name + ": found")
                            .css("color", "green")
                        );
                    }
                    if (msg.body == "process_commit")  {
                        $("#updates").append(
                            $("<li>")
                            .text(name + ": new match(es) available")
                            .css("color", "orange")
                        );
                    }
                    if (msg.body == "compile_commit")  {
                        $("#updates").append(
                            $("<li>")
                            .text(name + ": player profile stats updated")
                            .css("color", "orange")
                        );
                    }

                    msg.ack();
                }, {"ack": "client"});

                // POST
                $.post("/api/player/" + name + "/search");
                e.preventDefault();
            });
        </script>
    </body>
</html>
