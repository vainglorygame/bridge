<!doctype html>
<html>
    <head>
        <title>Vainsocial backend status</title>
    </head>
    <body>
        <p>
            <form id="update-form">
                <input type="text" id="update-name">
                <input type="checkbox" id="update-force">
                <label for="update-force">Force refresh</label>
                <input type="submit" value="Update">
            </form>
        </p>
        <p>
            <form id="update-random-form">
                <input type="submit" value="Update random player">
            </form>
        </p>

        <ul id="updates"></ul>

        <script src="https://cdn.jsdelivr.net/sockjs/1/sockjs.min.js"></script>
        <script type="text/javascript" src="/js/webstomp.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
        <script>
            let client;
            // set up the client
            if ('WebSocket' in window && (typeof WebSocket === 'function' || typeof WebSocket === 'object')) {
                client = webstomp.client("ws://localhost:15674/ws");
            } else {
                // http fallback
                client = webstomp.over(SockJS("http://localhost:15674/stomp"));
            }

            let notif = (text, color) => {
                $("#updates").append(
                    $("<li>")
                    .text(text)
                    .css("color", color)
                );
            };

            // connect
            client.connect("web", "web", () => notif("connected to socket", "purple"),
            (err) => notif("error connecting to socket: " + JSON.stringify(err), "red"));

            let subscribe = (name) => {
                // subscribe
                client.subscribe("/topic/player." + name, (msg) => {
                    notif(msg.body, "grey");
                    switch (msg.body) {
                        case "search_fail":
                            notif(name + ": not found", "red"); break;
                        case "search_success":
                            notif(name + ": found", "green"); break;
                        case "matches_update":
                            notif(name + ": new match(es) available", "orange"); break;
                        case "stats_update":
                            notif(name + ": player profile stats updated", "orange"); break;
                    }
                    msg.ack();
                }, {"ack": "client"});
            }

            $("#update-form").submit((e) => {
                e.preventDefault();
                let ign = $("#update-name").val(),
                    force = $("#update-force").is(":checked");

                subscribe(ign);
                if (force) {
                    $.post("/api/player/" + ign + "/search");
                } else {
                    $.post("/api/player/" + ign + "/update");
                }
            });
            $("#update-random-form").submit((e) => {
                e.preventDefault();
                $.post("/api/player").done((resp) => {
                    notif(resp.name + ": random user", "green");
                    subscribe(resp.name);
                });
            });
        </script>
    </body>
</html>
