<!doctype html>
<html>
    <head>
        <title>Vainsocial backend status</title>
    </head>
    <body>
        <form id="update-form">
            <input type="text">
            <input type="submit" value="Update">
        </form>

        <ul id="updates"></ul>
        <script src="https://cdn.jsdelivr.net/sockjs/1/sockjs.min.js"></script>
        <script type="text/javascript" src="/js/webstomp.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
        <script>
            // fallback (TODO)
            //var sock = SockJS("http://localhost:15674/stomp");
            //var client = webstomp.over(sock);
            let client = webstomp.client("ws://localhost:15674/ws");
            client.connect("web", "web", () => {
                $("#updates").append(
                    $("<li>")
                    .text("connected to socket")
                    .css("color", "purple")
                );
            }, (err) => {
                $("#updates").append(
                    $("<li>")
                    .text("error connecting to socket: " + err)
                    .css("color", "red")
                );
            });
            $("#update-form").submit(function(e) {
                let name = $("input:first").val();
                $.get("/api/player/name/" + name).done(function(player) {
                    $("#updates").append(
                        $("<li>")
                        .text(name + " (" + player.region + ")" + ": " +
                            "found in " + player.source + ", " +
                            "last update " + player.last_update
                        )
                        .css("color", "green")
                    );
                    client.subscribe("/topic/" + name, (msg) => {
                        $("#updates").append(
                            $("<li>")
                            .text(msg.body)
                            .css("color", "grey")
                        );

                        if (msg.body == "process_commit")  {
                            $("#updates").append(
                                $("<li>")
                                .text(name + ": new match(es) available")
                                .css("color", "orange")
                            );
                        }
                        if (msg.body == "compile_commit")  {
                            $("#updates").append(
                                $("<li>")
                                .text(name + ": player profile stats updated")
                                .css("color", "orange")
                            );
                        }

                        msg.ack();
                    }, {"ack": "client"});
                }).fail(function() {
                    $("#updates").append(
                        $("<li>")
                        .text(name + ": not found")
                        .css("color", "red")
                    );
                });
                e.preventDefault();
            });
        </script>
    </body>
</html>
